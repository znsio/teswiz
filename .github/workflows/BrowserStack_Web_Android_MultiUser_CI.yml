name: BrowserStack_Web_Android_MultiUser_CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - uses: actions/checkout@v6

      - name: Set up JDK 17
        uses: actions/setup-java@v5
        with:
          java-version: '17'
          distribution: temurin

      - name: Install Appium dependencies
        run: |
          node -v
          npm cache clean --force
          npm install
          npm list

      - name: Run TheApp Web tests
        id: theapp_web
        uses: ./.github/actions/run-and-collect-tests
        with:
          id: theapp-web
          display-name: "TheApp Web"
          config-path: "./configs/theapp/theapp_browserstack_web_config.properties"
          platform: "web"
          tag: "@theapp2 and @invalidLogin1 and @browserstack"
          artifact-name: "test-results-theapp-web"
          is-visual: "true"
          additional-env: ""
          applitools_api_key: ${{ secrets.TESWIZ_APPLITOOLS_API_KEY }}
          browserstack_username: ${{ secrets.BROWSERSTACK_CLOUD_USERNAME }}
          browserstack_key: ${{ secrets.BROWSERSTACK_CLOUD_KEY }}

      - name: Check for Failures and Add Summary
        run: |
          echo "Checking exit codes for all test runs..."
          fail=0
          summary="### ❌ Web + Android CI Test Failures\n"

          THEAPP_WEB_CODE="${{ steps.theapp_web.outputs.exit_code }}"

          if [ "$THEAPP_WEB_CODE" != "0" ]; then
            summary="${summary}- TheApp Web (exit code: $THEAPP_WEB_CODE)\n"
            fail=1
          fi

          if [ "$fail" -ne 0 ]; then
            summary="${summary}\n**Commit:** ${{ github.sha }}\n"
            summary="${summary}**Triggered by:** ${{ github.actor }}\n"
            summary="${summary}**Workflow:** [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})\n"
            echo -e "$summary" >> "$GITHUB_STEP_SUMMARY"
            exit 1
          else
            echo "✅ All test suites passed"
          fi
